<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Roots Tutor Academy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2E7D32; --dark-blue: #0D1B2A; --background-color: #F8F9FA;
            --card-bg: #FFFFFF; --text-color: #333333; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --loader-color: var(--primary-green);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        h1, h2 { color: var(--dark-blue); text-align: center; margin-bottom: 2rem; }
        .admin-section { background-color: var(--card-bg); padding: 2rem; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        button { background-color: var(--primary-green); color: white; padding: 1rem; font-size: 1.1rem; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        button:hover { background-color: #1B5E20; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .form-full-width { grid-column: 1 / -1; }
        .ai-drafter { border: 2px dashed var(--primary-green); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; }
        .ai-drafter h3 { text-align: center; margin-bottom: 1rem; color: var(--primary-green); }
        #ai-prompt { height: 80px; }
        #editor-container { height: 250px; margin-bottom: 1rem; }
        .management-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
        .management-table th, .management-table td { padding: 12px 10px; border: 1px solid #ddd; text-align: left; vertical-align: middle; word-wrap: break-word; }
        .management-table th { background-color: var(--dark-blue); color: white; }
        .action-buttons { display: flex; gap: 10px; }
        .btn-edit, .btn-delete { padding: 8px 12px; font-size: 0.9rem; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-edit { background-color: #2196F3; }
        .btn-delete { background-color: #f44336; }
        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Roots Tutor Academy - Admin Panel</h1>
        
        <section class="admin-section">
            <h2 id="content-form-title"><i class="fas fa-plus-circle"></i> Add or Edit Content</h2>
            <div class="ai-drafter">
                <h3><i class="fas fa-magic"></i> AI Article Drafter</h3>
                <label for="ai-prompt">Enter a topic for the AI to write about:</label>
                <textarea id="ai-prompt" placeholder="e.g., Write an article about the upcoming admission deadlines for NED University."></textarea>
                <button id="generate-draft-btn" style="width: 100%; margin-top: 1rem;">
                    <span id="generate-btn-text">Generate Draft</span>
                    <div class="loader" id="ai-loader" style="display: none;"></div>
                </button>
            </div>
            <form id="content-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-type">
                <div class="form-full-width">
                    <label for="content-title">Title</label><input type="text" id="content-title" required>
                </div>
                <div class="form-full-width" id="article-body-container">
                    <label>Article Content</label><div id="editor-container"></div>
                </div>
                <div id="common-fields-1"><label for="content-category">Category / Subject</label><select id="content-category"></select></div>
                <div id="common-fields-2"><label for="content-link">Link (YouTube, PDF, or Article Page)</label><input type="url" id="content-link"></div>
                <div id="resource-fields-1" style="display: none;"><label for="resource-class">Class</label><select id="resource-class"><option>Matric</option><option>FSc</option><option>O-Levels</option></select></div>
                <div id="resource-fields-2" style="display: none;"><label for="resource-type">Type</label><select id="resource-type"><option value="video">Video</option><option value="pdf">PDF</option><option value="notes">Notes</option></select></div>
                <button type="submit" id="submit-btn" class="form-full-width">Add Content</button>
            </form>
            <div id="message" style="text-align: center; margin-top: 1rem; font-weight: 600;"></div>
        </section>

        <section class="admin-section">
            <h2><i class="fas fa-inbox"></i> Tutor Requests</h2>
            <div class="table-container">
                <table class="management-table">
                    <thead><tr><th>Date</th><th>Parent</th><th>Contact</th><th>Class</th><th>Notes</th></tr></thead>
                    <tbody id="requests-tbody"></tbody>
                </table>
            </div>
        </section>

        <section class="admin-section">
            <h2><i class="fas fa-edit"></i> Manage News & Articles</h2>
            <div class="table-container">
                <table class="management-table">
                    <thead><tr><th>Title</th><th>Category</th><th>Actions</th></tr></thead>
                    <tbody id="articles-tbody"></tbody>
                </table>
            </div>
        </section>

        <section class="admin-section">
            <h2><i class="fas fa-book-open"></i> Manage Learning Resources</h2>
            <div class="table-container">
                <table class="management-table">
                    <thead><tr><th>Title</th><th>Class</th><th>Subject</th><th>Actions</th></tr></thead>
                    <tbody id="resources-tbody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyChaU7FMhPkg-VI0lfctenjLKbaHUmBnZU",
            authDomain: "onnnnnnnn-86197.firebaseapp.com",
            projectId: "onnnnnnnn-86197",
            storageBucket: "onnnnnnnn-86197.appspot.com",
            messagingSenderId: "708226700407",
            appId: "1:708226700407:web:51b22d980cc650b1ba6272"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const quill = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], ['link'], [{ 'list': 'ordered'}, { 'list': 'bullet' }]] } });
        const contentForm = document.getElementById('content-form');
        const editId = document.getElementById('edit-id');
        const editType = document.getElementById('edit-type');
        const contentTitle = document.getElementById('content-title');
        const contentCategory = document.getElementById('content-category');
        const contentLink = document.getElementById('content-link');
        const resourceClass = document.getElementById('resource-class');
        const resourceType = document.getElementById('resource-type');
        const submitBtn = document.getElementById('submit-btn');
        const messageDiv = document.getElementById('message');
        
        const articleOptions = ['News', 'Results', 'Admissions', 'Blogs'];
        const resourceOptions = ['Physics', 'Chemistry', 'Math', 'Entry Test'];

        let currentView = 'article'; // Default view
        
        function setupFormFor(type) {
            currentView = type;
            const options = type === 'article' ? articleOptions : resourceOptions;
            contentCategory.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join('');
            document.getElementById('article-body-container').style.display = type === 'article' ? 'block' : 'none';
            document.getElementById('resource-fields-1').style.display = type === 'resource' ? 'block' : 'none';
            document.getElementById('resource-fields-2').style.display = type === 'resource' ? 'block' : 'none';
            resetForm();
        }

        function resetForm() {
            contentForm.reset();
            quill.root.innerHTML = '';
            editId.value = '';
            editType.value = '';
            submitBtn.textContent = `Add ${currentView.charAt(0).toUpperCase() + currentView.slice(1)}`;
            document.getElementById('content-form-title').innerHTML = `<i class="fas fa-plus-circle"></i> Add New ${currentView.charAt(0).toUpperCase() + currentView.slice(1)}`;
        }
        
        // --- DATA DISPLAY ---
        onSnapshot(query(collection(db, "tutorRequests"), orderBy("submittedAt", "desc")), (snapshot) => {
            const tbody = document.getElementById('requests-tbody');
            tbody.innerHTML = '';
            snapshot.forEach(doc => {
                const req = doc.data();
                const date = req.submittedAt ? new Date(req.submittedAt.seconds * 1000).toLocaleDateString() : 'N/A';
                tbody.innerHTML += `<tr><td>${date}</td><td>${req.parentName}</td><td>${req.phone}</td><td>${req.studentClass}</td><td>${req.notes || ''}</td></tr>`;
            });
        });

        function createManagementTable(collectionName, tbodyId, fields, type) {
            onSnapshot(query(collection(db, collectionName), orderBy("createdAt", "desc")), (snapshot) => {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    let cells = '';
                    fields.forEach(field => cells += `<td>${item[field] || ''}</td>`);
                    row.innerHTML = `${cells}<td><div class="action-buttons"><button class="btn-edit" data-id="${item.id}" data-type="${type}">Edit</button><button class="btn-delete" data-id="${item.id}" data-type="${type}">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
            });
        }
        createManagementTable('articles', 'articles-tbody', ['title', 'category'], 'article');
        createManagementTable('resources', 'resources-tbody', ['title', 'class', 'subject'], 'resource');
        
        // --- EDIT & DELETE ---
        document.addEventListener('click', (e) => {
            if (e.target.matches('.btn-delete')) {
                if (!confirm('Are you sure you want to delete this item?')) return;
                const id = e.target.dataset.id;
                const type = e.target.dataset.type;
                deleteDoc(doc(db, type === 'article' ? 'articles' : 'resources', id));
            }
            if (e.target.matches('.btn-edit')) {
                const id = e.target.dataset.id;
                const type = e.target.dataset.type;
                const itemData = // This requires fetching the specific doc, simplified here
                onSnapshot(doc(db, type === 'article' ? 'articles' : 'resources', id), (doc) => {
                    const data = doc.data();
                    setupFormFor(type);
                    editId.value = id;
                    editType.value = type;
                    contentTitle.value = data.title;
                    quill.root.innerHTML = data.content || '';
                    contentCategory.value = data.category || data.subject;
                    contentLink.value = data.link || '';
                    if (type === 'resource') {
                        resourceClass.value = data.class;
                        resourceType.value = data.type;
                    }
                    submitBtn.textContent = 'Update Content';
                    document.getElementById('content-form-title').innerHTML = `<i class="fas fa-pencil-alt"></i> Edit Content`;
                    window.scrollTo(0, 0);
                });
            }
        });

        // --- FORM SUBMIT ---
        contentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editId.value;
            const type = editType.value || currentView;
            const collectionName = type === 'article' ? 'articles' : 'resources';
            
            let data = {
                title: contentTitle.value,
                link: contentLink.value,
                createdAt: serverTimestamp()
            };
            if (type === 'article') {
                data.content = quill.root.innerHTML;
                data.category = contentCategory.value;
            } else {
                data.class = resourceClass.value;
                data.subject = contentCategory.value;
                data.type = resourceType.value;
            }

            if (id) { // Update
                await updateDoc(doc(db, collectionName, id), data);
                messageDiv.textContent = 'Content updated successfully!';
            } else { // Add
                await addDoc(collection(db, collectionName), data);
                messageDiv.textContent = 'Content added successfully!';
            }
            messageDiv.style.color = 'green';
            setTimeout(() => messageDiv.textContent = '', 3000);
            resetForm();
        });
        
        // --- AI DRAFTER LOGIC --- (Copied from previous version)
        const generateDraftBtn = document.getElementById('generate-draft-btn');
        const aiPrompt = document.getElementById('ai-prompt');
        const aiLoader = document.getElementById('ai-loader');
        const generateBtnText = document.getElementById('generate-btn-text');
        generateDraftBtn.addEventListener('click', async () => {
             const promptText = aiPrompt.value;
             if (!promptText) { alert('Please enter a topic.'); return; }
             generateDraftBtn.disabled = true; aiLoader.style.display = 'block'; generateBtnText.textContent = 'Generating...';
             try {
                 const geminiAPIUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${firebaseConfig.apiKey}`;
                 const systemPrompt = "You are an expert SEO content writer for Roots Tutor Academy, specializing in the Pakistani education sector. Write a well-structured blog post. Start with a catchy title, followed by the article body. The title should be enclosed in <title> tags, like <title>My Article Title</title>. The body should be in standard HTML paragraphs.";
                 const payload = { contents: [{ parts: [{ text: promptText }] }], tools: [{ "google_search": {} }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                 const response = await fetch(geminiAPIUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                 const result = await response.json();
                 const text = result.candidates[0].content.parts[0].text;
                 const titleMatch = text.match(/<title>(.*?)<\/title>/);
                 const title = titleMatch ? titleMatch[1] : "AI Generated Title";
                 const body = text.replace(/<title>.*?<\/title>/, '').trim();
                 contentTitle.value = title;
                 quill.root.innerHTML = body;
             } catch (error) { console.error("AI Error:", error); alert("Failed to generate draft.");
             } finally { generateDraftBtn.disabled = false; aiLoader.style.display = 'none'; generateBtnText.textContent = 'Generate Draft'; }
        });
        
        // Initial setup
        setupFormFor('article'); // Default to article form
    </script>
</body>
</html>


